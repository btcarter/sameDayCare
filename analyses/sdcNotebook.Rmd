---
title: "Same Day Care 2.0"
output:
  html_notebook:
    code_folding: hide
  html_document:
    df_print: paged
---

```{r setup}
# packages ####
library(dplyr)
library(stringr)
library(ggplot2)

# paths ####
data.dir.path <- file.path("C:","Users","CarteB","BILLINGS CLINIC", "CSI & David Hedges - Same Day Care Project", "data")
df.path <- file.path(data.dir.path, "All.2016-2019.2020-05-19.csv")
out.dir.path <- file.path("C:","Users","CarteB","BILLINGS CLINIC", "CSI & David Hedges - Same Day Care Project", "results")
```

```{r loadData}
# load data ####

cols <- c(
  "BeginDTS",
  "EncounterID",
  "AdmitMonthNBR",
  "AdmitDayNBR",
  "AdmitHourNBR",
  "AdmitDayOfWeek",
  "AdmitAgeNBR",
  "ResourceCVDSC",
  "ScheduleAppointmentID",
  "ActiveIndicatorCD",
  "ResourceTypeFLG",
  "Dept",
  "AppointmentLocationCVDisplayCVDSC",
  "EncounterType",
  "PersonID",
  "EthnicityDSC",
  "LanguageDSC",
  "MaritalStatusDSC",
  "RaceDSC",
  "GenderDSC",
  "ReligionDSC",
  "ReasonForVisitDSC",
  "ICD9CD",
  "DiagnosisPrioritySEQ",
  "DiagnosisDSC",
  "DiagnosisFreeTXT",
  "COPD",
  "HeartFailure",
  "Diabetes"
)

df <- read.csv2(
  df.path,
  header = FALSE,
  sep = ",",
  col.names = cols
  )

```


# Preprocessing

```{r preproc}

# correct bad entries ####
df[1,1] <- "2018-08-20 14:40:00.0000000"

df.processed <- df %>%
  mutate(
    BeginDTS = as.POSIXct(BeginDTS, format = "%Y-%m-%d %H:%M:%S"),
    PersonID = as.character(PersonID)
  ) %>% 
  mutate(
    ReligionDSC = na_if(ReligionDSC, " "),
    RaceDSC = na_if(RaceDSC, " "),
    EthnicityDSC = na_if(EthnicityDSC, " "),
    MaritalStatusDSC = na_if(MaritalStatusDSC, " "),
    ResourceTypeFLG = na_if(ResourceTypeFLG, "NULL"),
    Dept = na_if(Dept, "NULL"),
    DiagnosisPrioritySEQ = as.numeric(
      as.character(
        DiagnosisPrioritySEQ
      )
    )
  ) %>%
  droplevels() %>% 
  filter(
    BeginDTS > "2016-12-31",
    EncounterType %in% c("Outpatient Clinic", "Inpatient")
  )

# make a list of SDC/EC facilities
# sd.ec.facilities <- df %>% 
#   filter(
#     str_detect(AppointmentLocationCVDisplayCVDSC,
#                "SDC|Same Day Care|EC|Express Care")
#   ) %>%
#   select(
#     AppointmentLocationCVDisplayCVDSC
#   ) %>%
#   distinct()

sdc.ec.facilities <- c("Heights Express Care",
                       "SDC Downtown",
                       "SDC West",
                       "SDC Heights",
                       "Grand Express Care",
                       "Billings Clinic Downtown EC",
                       "Central Express Care",
                       "SDC Downtown Nurse",
                       "SDC West Nurse")

# make functions ####
get.sdc.pts <- function(x){
    # select IDs who used SDC ####
  ids <- x %>% 
    filter(
      AppointmentLocationCVDisplayCVDSC %in% sdc.ec.facilities
    ) %>%
    distinct(
      PersonID
    )
  
  # filter for IDs that appeared in SDC
  df <- x %>%
    filter(
      PersonID %in% ids$PersonID
    )
  
  return(df)
}

# steps ####
  # sort by date/participant
  # find date of first SDC/EC for each participant
  # make variable denoting if the following encounter occured within 14 days of the SDC/EC encounter

# SDC processing ####

df.sdc <- df.processed %>% # find SDC pts
  get.sdc.pts() %>% 
  arrange(
    PersonID,
    BeginDTS,
    AdmitHourNBR
  )

# Demographics dataframe ####

df.sdc.demographics <- df.sdc %>%
  distinct_at(
    "PersonID",
    .keep_all = TRUE
  ) %>% 
  select(
    PersonID,
    AdmitAgeNBR,
    EthnicityDSC,
    RaceDSC,
    LanguageDSC,
    MaritalStatusDSC,
    GenderDSC,
    ReligionDSC,
    COPD,
    HeartFailure,
    Diabetes
  ) %>% 
  mutate(
    LanguageDSC = na_if(LanguageDSC, " "),
    AdmitAgeNBR = as.numeric(as.character(AdmitAgeNBR))
  )

# combine ICD9s into a single observation per encounter ####

df.sdc.icd9.priority <- df.sdc %>% 
  group_by(
    PersonID,
    BeginDTS,
    AppointmentLocationCVDisplayCVDSC
  ) %>% 
  arrange(
    DiagnosisPrioritySEQ
  ) %>% 
  slice(1) %>%
  select(
    PersonID,
    BeginDTS,
    AppointmentLocationCVDisplayCVDSC,
    ICD9.priority = ICD9CD
  ) %>% 
  ungroup()

df.sdc.icd9.list <- df.sdc %>%
  group_by(
    PersonID,
    BeginDTS,
    AppointmentLocationCVDisplayCVDSC
  ) %>%
  arrange(
    DiagnosisPrioritySEQ
  ) %>% 
  count(
    ICD9CD
  ) %>% 
  summarise(
    ICD9CD = paste(ICD9CD, collapse = "; ")
  )
  
df.sdc.diagnosisdsc.list <- df.sdc %>%
  group_by(
    PersonID,
    BeginDTS,
    AppointmentLocationCVDisplayCVDSC
  ) %>%
  arrange(
    DiagnosisPrioritySEQ
  ) %>%
  count(
    DiagnosisDSC
  ) %>% 
  summarise(
    DiagnosisDSC = paste(DiagnosisDSC, collapse = "; ")
  )

df.sdc.diagnosisfreetxt.list <- df.sdc %>%
  group_by(
    PersonID,
    BeginDTS,
    AppointmentLocationCVDisplayCVDSC
  ) %>%
  arrange(
    DiagnosisPrioritySEQ
  ) %>%
  count(
    DiagnosisFreeTXT
  ) %>% 
  summarise(
    DiagnosisFreeTXT = paste(DiagnosisFreeTXT, collapse = "; ")
  )
  
df.sdc.dept <- df.sdc %>% 
  group_by(
    PersonID,
    BeginDTS,
    AppointmentLocationCVDisplayCVDSC
  ) %>%
  arrange(
    DiagnosisPrioritySEQ
  )%>% 
  count(
    Dept
  ) %>% 
  summarise(
    Dept = paste(Dept, collapse = "; ")
  )

df.sdc.reasonforvisit.list <- df.sdc %>% 
  group_by(
    PersonID,
    BeginDTS,
    AppointmentLocationCVDisplayCVDSC
  ) %>%
  arrange(
    DiagnosisPrioritySEQ
  )%>% 
  count(
    ReasonForVisitDSC
  ) %>% 
  summarise(
    ReasonForVisitDSC = paste(ReasonForVisitDSC, collapse = "; ")
  )


df.sdc.flattened <- df.sdc.icd9.list %>%
  left_join(
    df.sdc.icd9.priority,
    by = c("PersonID", "BeginDTS", "AppointmentLocationCVDisplayCVDSC")
  ) %>% 
  left_join(
    df.sdc.diagnosisdsc.list,
    by = c("PersonID", "BeginDTS", "AppointmentLocationCVDisplayCVDSC")
  ) %>% 
  left_join(
    df.sdc.diagnosisfreetxt.list,
    by = c("PersonID", "BeginDTS", "AppointmentLocationCVDisplayCVDSC")
  ) %>% 
  left_join(
    df.sdc.reasonforvisit.list,
    by = c("PersonID", "BeginDTS", "AppointmentLocationCVDisplayCVDSC")
  ) %>%
  left_join(
    df.sdc.dept,
    by = c("PersonID", "BeginDTS", "AppointmentLocationCVDisplayCVDSC")
  ) %>% 
  left_join(
    df.sdc.demographics,
    by = c("PersonID")
  ) %>%
  ungroup() %>% 
  arrange(
    PersonID,
    BeginDTS,
    AppointmentLocationCVDisplayCVDSC
  ) %>% 
  mutate(
    BeginDTS = as.POSIXct(BeginDTS)
  ) %>% 
  arrange(
    PersonID,
    BeginDTS
  ) %>% 
  mutate(
    return_in_14 = ifelse(
      lead(BeginDTS) - BeginDTS <= 1209600 &
        lead(BeginDTS) - BeginDTS > 0 &
        lead(PersonID) == PersonID &
        AppointmentLocationCVDisplayCVDSC %in% sdc.ec.facilities,
      TRUE,
      FALSE
    ),
    return_in_14_sameICD = ifelse(
      lead(BeginDTS) - BeginDTS <= 1209600 &
        lead(BeginDTS) - BeginDTS > 0 &
        lead(PersonID) == PersonID &
        AppointmentLocationCVDisplayCVDSC %in% sdc.ec.facilities &
        ICD9.priority == lead(ICD9.priority),
      TRUE,
      FALSE
    ),
    Facility = ifelse(AppointmentLocationCVDisplayCVDSC %in% sdc.ec.facilities, "SDC or EC Facility", "Other Facility"),
    HeartFailure = as.factor(as.logical(HeartFailure)),
    COPD = as.logical(COPD),
    Diabetes = as.logical(Diabetes)
  )

```

`r nrow(df.sdc)` patient records were selected via SQL query from the electronic health record (EHR) on the basis of a visit to a Same Day Care or Express Care facility between the years 2017-2019. Entries in the EHR without entered data or with "NULL" were then recoded as `NA`. Records created for the same patient, with the same date and time stamp and location were then combined into a single observation. ICD-10 codes were combined into a single array in the order of their priority, and a new variable was created to code for the priority ICD-10 code. This reduced the total number of observations to `r nrow(df.sdc.flattened)` individual true patient encounters.

A logical indicator variable was then created to show if the patient returned to a Billings Clinic facility within 14 days of a visit to a same day care or Express Care Facility. A similar variable was also created to indicate if that patient returned within 14 days and had the same priority ICD-10 code. The following facilities were coded as same day care facilities:

```{r}
knitr::kable(sdc.ec.facilities, col.names = c("Same Day Care and Express Care Facilities"))
```

# Analysis

## Descriptive statistics

```{r encountersPerPerson}
encounterStats <- df.sdc.flattened %>% 
  group_by(
    PersonID
  ) %>% 
  summarise(
    Encounters = n(),
    Encounters_sdc = sum(
      ifelse(AppointmentLocationCVDisplayCVDSC %in% sdc.ec.facilities,
             TRUE,
             FALSE)
    ),
    return_after_sdc = sum(return_in_14),
    return_after_sdc_sameICD = sum(return_in_14_sameICD)
  )

df.sdc.demographics.combined <- df.sdc.demographics %>% 
  left_join(
    encounterStats,
    by = c("PersonID")
  ) %>% 
  mutate(
    sdc_returns_str = ifelse(return_after_sdc_sameICD > 0,
                                     "Returned in 14 days with same ICD-10",
                                     ifelse(return_after_sdc > 0,
                                            "Returned in 14 days",
                                            "Did not return")
                                     )
  )

```

### Who are the SDC or EC patients?

```{r summStats}
DESC <- compareGroups::compareGroups(
  sdc_returns_str ~ AdmitAgeNBR + Encounters + Encounters_sdc + return_after_sdc + return_after_sdc_sameICD + GenderDSC + RaceDSC + EthnicityDSC + MaritalStatusDSC,
  df.sdc.demographics.combined, 
  max.xlev = 22
  )

tab <- compareGroups::createTable(DESC)

compareGroups::export2md(tab, caption = "Summary descriptives of patients by whether or not they returned within 14 days.")

female <- update(tab, x = update(DESC, . ~ . - GenderDSC, subset = GenderDSC == "FEMALE",  simplify = FALSE), show.n = FALSE, show.p.overall = FALSE)
male <- update(tab, x = update(DESC, . ~ . - GenderDSC, subset = GenderDSC == "MALE", simplify = FALSE), show.p.overall = FALSE)

genders <- cbind("Females" = female, "Males" = male)

compareGroups::export2md(genders, caption = "Summary descriptives by gender.")
```

### When did the encounters happen?

```{r, fig.cap="test"}
df.sdc.flattened %>% 
  mutate(
    BeginDTS = as.Date(BeginDTS)
  ) %>% 
  group_by(
    BeginDTS,
    Facility
  ) %>% 
  summarise(
    n = n()
  ) %>% 
  ungroup %>% 
  ggplot(
    aes(
      BeginDTS,
      n,
      color = Facility
    )
  ) +
  geom_line(alpha = 0.6) +
  geom_point(alpha = 0.8) +
  theme_classic() +
  labs(
    title = "Patient encounters",
    x = "Date",
    y = "Number of encounters",
    color = "Facility"
  )
```

### Priority ICD9 codes

#### For SDC or EC facilities
```{r}
df.sdc.flattened %>%
  filter(
    Facility == "SDC or EC Facility"
  ) %>% 
  group_by(
    ICD9.priority
    ) %>%
  count() %>% 
  arrange(
    desc(n),
    ICD9.priority
  )
```

#### All other facilities

```{r}
df.sdc.flattened %>%
  filter(
    Facility == "Other Facility"
  ) %>% 
  group_by(
    ICD9.priority
    ) %>%
  count() %>% 
  arrange(
    desc(n),
    ICD9.priority
  )
```


# Predictive modeling

## Natural Language Processing: How many groups are there?

## Linear Model

```{r}
df.sdc.flattened.filtered <- df.sdc.flattened %>% 
  filter(
    AppointmentLocationCVDisplayCVDSC %in% sdc.ec.facilities
  ) %>% 
  arrange(
    PersonID,
    BeginDTS
  ) %>% 
  group_by(
    PersonID
  ) %>% 
  slice(
    1
  ) %>% 
  droplevels() 
  mutate(
    return_str = ifelse(
      return_in_14_sameICD > 0,
      "Returned same ICD10",
      ifelse(
        return_in_14 > 0,
        "Returned new ICD10",
        "Did not return"
      )
    )
  )

linear.model <- lm(
  return_str ~ AdmitAgeNBR + GenderDSC + RaceDSC + EthnicityDSC + MaritalStatusDSC + AppointmentLocationCVDisplayCVDSC + ICD9.priority + Dept + HeartFailure,
  data = df.sdc.flattened.filtered
)

```

Some PersonID's appear in the dataset multiple times. This could bias the dataset by giving too much weight to that participant's contribution and inflate Type I error. To guard against this, I chose to only retain the first encounter with Same Day Care or Express Care for each PersonID. All other observations were then removed from the dataset. This resulted in `r nrow(df.sdc.flattened.filtered)` observations in the final data set.

## Linear Mixed-Effects Model

```{r}
library(lme4)
library(lmerTest)

model <- lmer(return_in_14 ~ AdmitAgeNBR + GenderDSC + RaceDSC + EthnicityDSC + MaritalStatusDSC + (1|PersonID) + AppointmentLocationCVDisplayCVDSC + ICD9.priority + Dept + HeartFailure,
              df.sdc.flattened)


```


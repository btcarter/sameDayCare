---
title: "The Same Day Care Report, v0.3"
author: "Benjamin T. Carter, PhD, CSI, Billings Clinic"
date: "Generated: `r Sys.time()`"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
---

```{r include=FALSE}
knitr::opts_chunk$set(message=FALSE, error=FALSE, warning=FALSE)
```

```{r dataLoadPrep}
# packagaes
library(dplyr)
library(tidyr)
library(icd.data) # for reading in ICD10 classifying information; also consider packages: comorbidity, icd

# paths
data.dir.path <- file.path("C:",
                           "Users",
                           "CarteB",
                           "BILLINGS CLINIC", 
                           "CSI & David Hedges - Same Day Care Project", 
                           "data")

df.name <- file.path(data.dir.path, "sdc.flat.xlsx")

# get data
df <- readxl::read_xlsx(df.name)

ICD <- icd10cm2016 %>% # icd codes
  mutate(
    code = as.character(code)
  )

tops <- readRDS(file = file.path(data.dir.path, "lda.model.rds")) # topic modeling

df <- df %>% # add topics for encounters and ICD code chapters for Priority ICD-10
  left_join(
    ICD,
    by = c("ICD_code" = "code")
  ) %>% 
  mutate(
    EncounterID = as.character(EncounterID)
  ) %>% 
  left_join(
    tops$gammas,
    by = c("EncounterID" = "document")
  ) %>%
  select(
    -c(
      billable,
      short_desc,
      long_desc,
      three_digit,
      major,
      gamma
    )
  ) %>%
  mutate(
    topic = as.character(topic)
  ) %>%  
  filter(
    !is.na(return_in_14)
  ) %>% 
  group_by(EncounterID) %>% 
  slice_head() %>% 
  ungroup()

# fill in NA return information with "No return"
geo.vars <- c("state_fips",
              "FIPS",
              "county_fips",
              "RUCC_2013",
              "city",
              "state",
              "ZipCode",
              "country",
              "po_box",
              "id",
              "census_tract",
              "census_block",
              "geoid_block",
              "geoid_tract",
              "NAME",
              "median_income_2018",
              "median_home_value_2018",
              "dist_eu_pt_sdc",
              "dist_eu_pt_return")

return.vars <- c("return_ICD_all",
                 "return_ICD_block_all",
                 "return_DiagnosisDSC_all",
                 "return_ReasonForVisit_all",
                 "return_Building",
                 "return_NurseUnit")

df[return.vars] <- replace_na(df[return.vars], list("return_ICD_all" = "No return",
                                                    "return_ICD_block_all" = "No return",
                                                    "return_DiagnosisDSC_all" = "No return",
                                                    "return_ReasonForVisit_all" = "No return",
                                                    "return_Building" = "No return",
                                                    "return_NurseUnit" = "No return"
                                                    )
                              )

joined <- c("Life Partner",
            "Married")

separated <- c("Divorced",
               "Separated",
               "Widowed")

singles <- c("Not Obtained",
             "Patient Refused",
             "Single",
             "Unknown")


df <- df %>% 
  filter(
    !(return_Building %in% c("ROUNDUP MEMORIAL HEALTHCARE", "ROUNDUP MEMORIAL CLINIC")),
    AdmitAge >= 18
  ) %>% 
  mutate(
    RUCC_2013_binary = if_else(
      RUCC_2013 <= 3,
      "Urban",
      "Rural"
    ),
    Marital_Status = if_else(
      Marital_Status %in% joined,
      "Married",
      if_else(
        Marital_Status %in% separated,
        "Separated",
        "Single"
      )
    ),
    NurseUnit = if_else(
      NurseUnit %in% c("SDC West Nurse",
                       "WE Same Day Care",
                       "West End SDC"),
      "West End SDC",
      if_else(
        NurseUnit %in% c("Heights Same Day Care", 
                         "HTS Same Day Care"),
        "Heights Same Day Care",
        NurseUnit
      )
    )
  )

return.vars <- union(return.vars,
                     "days_to_return")


start.rows <- setdiff(names(df), c(geo.vars, return.vars))

```

This is a global report of all parts of the SDC project.

# Introduction

```{r child='introduction.Rmd'}
```

## Data Quality

```{r quality}
total <- nrow(df)
completed <- complete.cases(df[start.rows])
sum_completed_no_geo <- sum(completed)

completed <- complete.cases(df[c(start.rows, geo.vars)])
sum_completed_geo <- sum(completed)
```

A total of `r nrow(df)` cases were identified. Of these cases only `r sum_completed_no_geo` had complete case information, when including geographic information (defined as a resendential address recognized by the Census Geocoding API) the number of complete cases drops to `r sum_completed_geo`. This represents only `r 100*sum_completed_geo/nrow(df)`% of the original dataset, and this is after the data were programatically curated. A manual curation might recover some cases, or exclude others. In many cases, address data were incomplete (e.g. the street field was not completed), incorrect (e.g. a state was entered in place of a zip code), or inappropriate (e.g. a PO box address was listed as a residential address). In some cases adhoc entries were used to indicate homelessness (e.g. 1234 Homeless street), however these entries were not standardized, making a manual curation unrealistic.

It is recommended that address data be strictly regulated. The distinction between a mailing address and resendential address should be enforced. The entry of homelessness should be standardized, perhaps in a separate field.

```{r addingVars}
# locations
SDCEC <- unique(df$NurseUnit)

SDC <- c("Same Day Care",
         "WE Same Day Care",
         "HTS Same Day Care",
         "Heights Same Day Care",
         "SDC Downtown Nurse",
         "West End SDC",
         "SDC West Nurse")

# Exclude Roundup b/c we don't have permission to pull data.

hospitals <- c("BIllings Clinic Downtown", 
               "Billings Clinic Hospital",
               "PIONEER MEDICAL CENTER",
               "STILLWATER BILLINGS CLINIC RHC",
               "WHEATLAND MEMORIAL HEALTHCARE",
               "LIVINGSTON HEALTHCARE",
               "Daniels Memorial Healthcare Center",
               "GLENDIVE MEDICAL CENTER",
               "STILLWATER BILLINGS CLINIC",
               "SHERIDAN MEMORIAL HOSPITAL ASSOCIATION",
               "NORTH BIG HORN HOSPITAL",
               "BEARTOOTH BILLINGS CLINIC"
               ) # these locations have either 24/7 emergency services or an ER listed on their website.

```

## General Trends

```{r genTab1}
library(compareGroups)

tab1 <- descrTable(~., df)
export2md(tab1)

```

```{r gentrends}
library(ggplot2)

respVar <- "return_in_14"

title <- paste("Encounters by time of year and ", respVar, sep = "")

df %>% 
  ggplot(
    aes(DTS, fill= .data[[respVar]])
  ) +
  geom_histogram(bins = 36, alpha = 0.75) +
  theme_classic() +
  labs(
    title = title,
    x = "Date",
    y = "Total Visits",
    fill = respVar
  )

# plot: number of visits to SDC/EC
traffic <- df %>% 
  group_by(
    PersonID
  ) %>% 
  summarise(
    n = n()
  ) %>% 
  ungroup()

traffic %>% 
  ggplot(
    aes(n)
  ) +
  geom_histogram(binwidth = 1) +
  scale_y_log10() +
  theme_classic() +
  labs(
    title = "Distribution of Number of Visits to SDC/EC",
    x = "Number of Visits",
    y = "Log10 of Number of Individuals",
    caption = "This depicts the number of individuals making a specified number of visits to SDC/EC during the years 2017-2019."
  )
```

## ICD-10 Trends

ICD-10 codes are ranked according to priority in the EMR, 0-99. I assume that smaller number denotes higher rank (since very few encounters have an ICD-10 code with a priority of 99 but all have at least one code with a priority of 0). How is the priority rank determined?

Below are two tables with the ten most common ICD-10 codes found in SDC encounters that reappear in a subsequent encounter. This includes any code to appear associated with either encounter and is not limited to the priority code. The first lists the full ICD-10 code as found in the EMR. The second displays the three-digit code only (resulting in a smaller number of codes used overall).

```{r}
# How often does the Priority ICD-10 appear in the follow-up visit?

split_it <- function(LIST){
  y <- unlist(
    strsplit(LIST, split = "; ")
  )
  return(y)
}

sum_it <- function(LIST1, LIST2){
  b <- sum(split_it(LIST1) %in% split_it(LIST2))
  return(b)
}

relist_it <- function(LIST1, LIST2){
  x <- split_it(LIST1) %in% split_it(LIST2)
  y <- paste(unlist(strsplit(LIST1, split = "; "))[x], collapse = "; ") 
  return(y)
}


df.returning.icds <- df %>%
  select(
    EncounterID,
    ICD_code,
    ICD_all,
    return_ICD_all,
    ICD_block_all,
    return_ICD_block_all
  ) %>% 
  group_by(EncounterID) %>% 
  mutate(
    priority_icd_appearance = if_else(
      ICD_code %in% split_it(return_ICD_all),
      TRUE,
      FALSE
    ),
    any_icd_appearance = if_else(
      sum_it(ICD_all, return_ICD_all) > 0,
      TRUE,
      FALSE
    ),
    reappearing_icds = if_else(
      sum_it(ICD_all, return_ICD_all) > 0,
      relist_it(ICD_all, return_ICD_all),
      "Nothing"
    ),
    any_icd_block_appearance = if_else(
      sum_it(ICD_block_all, return_ICD_block_all) > 0,
      TRUE,
      FALSE
    ),
    reappearing_icd_block = if_else(
      sum_it(ICD_block_all, return_ICD_block_all) > 0,
      relist_it(ICD_block_all, return_ICD_block_all),
      "Nothing"
    )
  ) %>% 
  ungroup()

# How often does one of the ICD-10s appear in the follow-up?

full.code.frq <- data.frame(codes = 
                                 unlist(
                                   strsplit(df.returning.icds$reappearing_icds, 
                                            split = "; ")
                                   )
                               ) %>% 
  group_by(codes) %>% 
  summarise(n = n()) %>% 
  arrange(
    desc(n)
  ) %>% 
  filter(codes != "Nothing") %>% 
  left_join(
    ICD,
    by = c("codes" = "code")
  ) %>% 
  select(
    -c("billable", "long_desc", "three_digit")
  )

knitr::kable(full.code.frq %>% slice_head(n=10))

block.frq <- data.frame(codes = 
                                 unlist(
                                   strsplit(df.returning.icds$reappearing_icd_block, 
                                            split = "; ")
                                   )
                               ) %>% 
  group_by(codes) %>% 
  summarise(n = n()) %>% 
  arrange(
    desc(n)
  ) %>% 
  filter(codes != "Nothing") %>% 
  left_join(
    ICD,
    by = c("codes" = "code")
  ) %>% 
  select(
    -c("billable", "long_desc", "three_digit")
  )

knitr::kable(block.frq %>% slice_head(n=10))

# how are they associated with return?
df <- df.returning.icds %>% 
  select(
    EncounterID,
    priority_icd_appearance,
    any_icd_appearance,
    any_icd_block_appearance,
    reappearing_icds,
    reappearing_icd_block
  ) %>% 
  right_join(
    df,
    by = c("EncounterID" = "EncounterID")
  )

# codes that reappear most often
top <- df %>% 
  filter(reappearing_icds != "Nothing") %>% 
  group_by(reappearing_icds) %>% 
  summarise(n = n()) %>% 
  ungroup() %>% 
  left_join(
    ICD,
    by = c("reappearing_icds" = "code")
  ) %>% 
  select(
    chapter,
    reappearing_icds,
    short_desc,
    n
  ) %>% 
  arrange(desc(n)) %>% 
  slice_head(n=10) %>% 
  arrange(chapter)

knitr::kable(top,
             caption = "ICD-10 codes and the number of times they reappear in a subsequent visit (n)") %>% kableExtra::collapse_rows(columns = 1, valign = "top")

```

A total of `r nrow(full.code.frq)` full codes and `r nrow(block.frq)` three-digit codes reappear in the subsequent encounter.

## Exploring Reasons for Visit

![Perplexity Plot Plot](C:\Users\CarteB\BILLINGS CLINIC\CSI & David Hedges - Same Day Care Project\R\analyses\perplexityPlot_ReasonForVisit.jpeg)

A Latent Dirichlet Analysis was used for exploratory topic modelling. There appear to be approximately 100 different categories for reasons for visit to SDC/EC. The lowest perplexity score was achieved with 97 different groups. This has been combined with the dataset for XGBoost.

0## Questions to explore:

Is this correlated with ICD-10?

How accurate are the groups? (remove numbers from dtm, rectify acronyms, find CC lexicon)


# Returns to in 14 days to any location
```{r results='asis'}
# make data frames for response variable and data
y.var <- "return_in_14"

# send data to rmd
params=list(respVar = y.var,
            d.frame = df)


res <- knitr::knit_child('descriptiveAnalysis.Rmd', quiet = TRUE)
cat(res, sep = '\n')

```

```{r xgboost, results='asis'}
vars.ml <- c(
  "RUCC_2013",
  "AdmitAge",
  "Language",
  "Race",
  "Marital_Status",
  "Sex",
  "Religion_binary",
  "Building",
  "tribal_affil",
  "Fed_Ethnicity",
  "po_box",
  "median_income_2018",
  "median_home_value_2018",
  "dist_eu_pt_sdc",
  "dist_eu_pt_return",
  "chapter",
  "topic"
)

# make dataframe with complete cases for data
y.var <- "return_in_14"

df.ml <- df[vars.ml]
df.ml[[y.var]] <- as.numeric(df[[y.var]])

df.ml <- df.ml[complete.cases(df.ml),]

# send data to rmd
params=list(respVar = y.var,
            d.frame = df.ml)

res <- knitr::knit_child('xgboost.Rmd', quiet = TRUE)
cat(res, sep = '\n')

```

# Returns to hospital(s) 24 hours after and within 14 days of SDC/EC visit with same ICD-10

```{r}
df.x <- df %>% 
  mutate(
    return = if_else(
      days_to_return <= 14 & 
        days_to_return > 1 & 
        ICD_code %in% return_ICD_all &
        return_Building %in% hospitals &
        any_icd_block_appearance == TRUE,
      TRUE,
      FALSE
    )
  ) %>% 
  select(
    -return_in_14
  )
```

```{r echo=FALSE, results='asis'}
# make data frames for response variable and data
y.var <- "return"

# send data to rmd
params=list(respVar = y.var,
            d.frame = df.x)

res <- knitr::knit_child('descriptiveAnalysis.Rmd', quiet = TRUE)
cat(res, sep = '\n')
```

```{r echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
vars.ml <- c(
  "RUCC_2013",
  "AdmitAge",
  "Race",
  "Marital_Status",
  "Sex",
  "Religion_binary",
  "tribal_affil",
  "Fed_Ethnicity",
  "po_box",
  "median_income_2018",
  "median_home_value_2018",
  "dist_eu_pt_sdc",
  "dist_eu_pt_return",
  "chapter",
  "topic"
)

# make dataframe with complete cases for data
y.var <- "return"

df.ml <- df.x[vars.ml]
df.ml[[y.var]] <- as.numeric(df.x[[y.var]])

df.ml <- df.ml[complete.cases(df.ml),]

# send data to rmd
params=list(respVar = y.var,
            d.frame = df.ml)

res <- knitr::knit_child('xgboost.Rmd', quiet = TRUE)
cat(res, sep = '\n')

```

# Frequent Fliers

```{r makeFfDf}
df.x <- df %>%
  group_by(
    PersonID,
    NurseUnit
  ) %>%
  summarise(
    `TotalVisits` = n()
  ) %>%
  ungroup() %>%
  filter(
    NurseUnit %in% SDC
  ) %>%
  group_by(
    PersonID
  ) %>%
  summarise(
    TotalSdcVisits = sum(TotalVisits)
  ) %>%
  ungroup() %>%
  mutate(
    frequentFlier = if_else(
      `TotalSdcVisits` >= quantile(TotalSdcVisits,
                                prob = 0.95,
                                na.rm = TRUE),
      "Frequent flier",
      "Infrequent flier"
    )
  ) %>%
  select(
    -TotalSdcVisits
  ) %>%
  right_join(
    df,
    by = c("PersonID" = "PersonID")
  )

df.x <- df.x %>%
  mutate(
    frequentFlier = if_else(
      is.na(frequentFlier),
      "Infrequent flier",
      frequentFlier
    )
  ) %>% 
  mutate(
    frequentFlier = if_else(
      frequentFlier == "Frequent flier",
      TRUE,
      FALSE
    )
  )

```

"Frequent fliers" were identified as follows: the number of visits to a Same Day Care facility during 2017-2019 were counted. Individuals in the 95$^{th}$ percentile of this distribution were then indentified. Visits to Express Care facilities were not included in the total number of visits.


```{r echo=FALSE, results='asis'}
# make data frames for response variable and data
y.var <- "frequentFlier"

# send data to rmd
params=list(respVar = y.var,
            d.frame = df.x)

res <- knitr::knit_child('descriptiveAnalysis.Rmd')
cat(res, sep = '\n')
```

```{r echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
vars.ml <- c(
  "RUCC_2013",
  "AdmitAge",
  "Race",
  "Marital_Status",
  "Sex",
  "Religion_binary",
  "tribal_affil",
  "Fed_Ethnicity",
  "po_box",
  "median_income_2018",
  "median_home_value_2018",
  "dist_eu_pt_sdc",
  "dist_eu_pt_return",
  "chapter",
  "topic"
)

# make dataframe with complete cases for data
y.var <- "frequentFlier"

df.ml <- df.x[vars.ml]
df.ml[[y.var]] <- as.numeric(df.x[[y.var]])

df.ml <- df.ml[complete.cases(df.ml),]

# send data to rmd
params=list(respVar = y.var,
            d.frame = df.ml)

res <- knitr::knit_child('xgboost.Rmd',quiet = TRUE)
cat(res, sep = '\n')

```


# Sequence and Association Mining

## Status: In Progress

## What is it?

Sequence and Association mining are methods by which events are queried to determine if there is a correlation between them. Sequence mining considers the temporal order of events while association mining is agnoistic to temporal order.


# Exploring Geography | Where are they from?

In progress
- What proportion of SDC encounters from each neighborhood results in a return? A return to SDC or to other facility? Are there hotspots?

# Conclusion

```{r child='Summary.Rmd'}
```




---
title: "The Same Day Care Report, v0.3"
author: "Benjamin T. Carter, PhD, CSI, Billings Clinic"
date: "Generated: `r Sys.time()`"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    fig_width: 6
    fig_height: 12
---

```{r include=FALSE}
knitr::opts_chunk$set(message=FALSE, error=FALSE, warning=FALSE)
```

```{r dataPrep}
library(icd.data)

data.dir.path <- file.path("C:",
                           "Users",
                           "CarteB",
                           "BILLINGS CLINIC", 
                           "CSI & David Hedges - Same Day Care Project", 
                           "data")

df.name <- file.path(data.dir.path, "sdc.flat.xlsx")

df <- readxl::read_xlsx(df.name)

# get data
ICD <- icd10cm2016 %>% # icd codes
  mutate(
    code = as.character(code)
  )

tops <- readRDS(file = file.path(data.dir.path, "lda.model.rds")) # topic modeling

df <- df %>% 
  left_join(
    ICD,
    by = c("ICD_code" = "code")
  ) %>% 
  mutate(
    EncounterID = as.character(EncounterID)
  ) %>% 
  left_join(
    tops$gammas,
    by = c("EncounterID" = "document")
  ) %>%
  select(
    -c(
      EncounterID,
      ICD_code,
      billable,
      short_desc,
      long_desc,
      three_digit,
      major,
      sub_chapter,
      gamma
    )
  ) %>%
  mutate(
    topic = as.character(topic)
  )
```


This is a global report of all parts of the SDC project.

# Introduction

```{r child='introduction.Rmd'}
```


# Descriptive analyses

## Returns to in 14 days
```{r child='descriptiveAnalysis.Rmd'}
```

## Returns to hospital after 24 hours and within 14 days
```{r child='descriptiveAnalysis.Rmd'}
```

## Frequenct Fliers
```{r child='descriptiveAnalysis.Rmd'}
```


# NLP & Predicting return from Reason for Visit

![Perplexity Plot Plot](C:\Users\CarteB\BILLINGS CLINIC\CSI & David Hedges - Same Day Care Project\R\analyses\perplexityPlot_ReasonForVisit.jpeg)

A Latent Dirichlet Analysis was used for exploratory topic modelling. There appear to be approximately 100 different categories for reasons for visit to SDC/EC. The lowest perplexity score was achieved with 97 different groups. This has been combined with the dataset for XGBoost.

# XGBoost and opening the black box

For this analysis, only variables know at or close to the time of the original SDC/EC encounter were preserved.

```{r xgboost, echo=FALSE, results='asis'}

# data prep
d.frame <- df %>% mutate(
    return_in_14 = as.numeric(return_in_14)
  ) %>% 
  select(
    -c(ICD, 
       ICD_block, 
       ICD_all, 
       ICD_block_all, 
       NAME, 
       BC_Ethnicity,
       city,
       state,
       ZipCode,
       census_block,
       census_tract,
       geoid_block,
       Building,
       NurseUnit,
       return_ICD_all,
       return_ICD_block_all,
       return_DiagnosisDSC_all,
       ReasonForVisit,
       ReasonForVisit_all,
       DiagnosisPrioritySEQ,
       DiagnosisType,
       DiagnosisDSC,
       days_to_return,
       return_Building,
       return_NurseUnit,
       dist_eu_pt_return,
       id,
       FIPS,
       PersonID,
       DTS,
       state_fips,
       county_fips,
       DiagnosisDSC_all,
       return_ReasonForVisit_all,
       geoid_tract,
       country,
       Religion,
       Fed_Ethnicity,
       po_box)
  ) %>% 
    left_join(
    ICD,
    by = c("ICD_code" = "code")
  ) %>% 
  mutate(
    EncounterID = as.character(EncounterID)
  ) %>% 
  left_join(
    tops$gammas,
    by = c("EncounterID" = "document")
  ) %>%
  select(
    -c(
      EncounterID,
      ICD_code,
      billable,
      short_desc,
      long_desc,
      three_digit,
      major,
      sub_chapter,
      gamma
    )
  ) %>%
  mutate(
    topic = as.character(topic)
  )

# make data frames for response variable and data
y.var <- "return_in_14"

# send data to rmd
params=list(respVar = y.var,
            d.frame = d.frame)

res <- knitr::knit_child('xgboost.Rmd')
cat(res, sep = '\n')

```

# Sequence and Association Mining

## Status: In Progress

## What is it?

Sequence and Association mining are methods by which events are queried to determine if there is a correlation between them. Sequence mining considers the temporal order of events while association mining is agnoistic to temporal order.

# Conclusion

```{r child='Summary.Rmd'}
```




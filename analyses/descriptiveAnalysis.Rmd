---
title: "SDC/EC Rating Project v0.2"
author: "Benjamin T. Carter, PhD"
date: "Generated: `r Sys.time()`"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
---

```{r include=FALSE}
knitr::opts_chunk$set(message=FALSE, error=FALSE, warning=FALSE)
```


# Problem
- SDC/EC exists to reduce congestion in the ER and clinics.
- Provides a place where individuals with uncomplicated medical problems can seek quick and covenient treatment.
- This mission is confounded when patients return to a BC facility because their healthcare problems were not adequately addressed.
- Can we predict which patients are most likely to return to a BC facility after SDC/EC?
- Can we prevent this return?

# Hypothesis
1. If risk factors for readmission are present in the EHR then these can be used to stratify patients at risk of acute readmission following a visit to Same Day Care or Express Care.

# Project Aims
1. Develop a model.
  1. Identify patient encounters followed by a return within 2 weeks.
  2. Perform a descriptive analysis of these encounters.
  3. Quantify the effect of pertinent variables.
  4. Develop an appropriate model to predict return.
  5. Report results in manuscript.
2. Validate the model.
  5. Test model in a clinical validation.
  6. Evaluate and report deployment.
  7. Revise model/deployment methods and redeploy.
  7. Report results in manuscript.

# Methods
- Encounters ID'd by [SQL query](https://github.com/btcarter/sameDayCare/blob/master/analyses/2019_query.sql) in SSMS.
- Exported to CSV
- Flattened, geocoded and return variables created by [R](https://github.com/btcarter/sameDayCare/blob/master/analyses/preprocessing.R)
  - This included adding additional data from American Communities Survey, 2010 Census, and RUCC codes.
  - Distance travelled to SDC/EC location was calculated as the geographic distance between the home address and SDC/EC facility. Street address was not retained in the final dataset, however city, state, postal code and country were retained.
- Exploratory topic modeling on Reason for Visit in [R via BAT](https://github.com/btcarter/sameDayCare/blob/master/analyses/nlp.R).

# Revisions
- Return is now in days (not hours, a mistake in v0.1)
- Topic modelling not added (discovered return time error too late to run it again).
- Added RUCC, median home value, median household income, Euclidean distance to SDC/EC facility as well as distance to return facility, returning ICD list, Diagnosis and Reason for visit.


```{r environment}
library(dplyr)
library(tidyr)
library(lubridate)
library(icd.data) # for reading in ICD10 classifying information and calculating risk scores also consider packages: comorbidity, icd
library(ggplot2)
library(compareGroups)

# paths
data.dir.path <- file.path("C:","Users","CarteB","BILLINGS CLINIC", 
                           "CSI & David Hedges - Same Day Care Project", "data")

out.dir.path <- file.path("C:","Users","CarteB","BILLINGS CLINIC", 
                          "CSI & David Hedges - Same Day Care Project", "results")

# data

df.flat.name <- file.path(data.dir.path, "sdc.flat.xlsx")

df.flat <- readxl::read_xlsx(df.flat.name)

ICD <- icd10cm2016 %>%
  mutate(
    code = as.character(code)
  )

SDCEC <- unique(df.flat$NurseUnit)

# clean up
df.flat <- df.flat %>% 
  filter(
    !is.na(return_in_14)
  ) %>% 
  mutate(
    return_in_14_sdc = if_else(
      return_in_14 == TRUE & return_NurseUnit %in% SDCEC,
      TRUE,
      FALSE
    ),
    return_types = if_else(
      return_in_14_sdc == TRUE,
      "SDC",
      if_else(
        return_in_14 == TRUE,
        "Other Facility",
        "No return"
      )
    )
  )

```

# Descriptive Analysis of All SDC/EC Encounters

## Data Quality

```{r}
total <- nrow(df.flat)
completed <- complete.cases(df.flat[c(1:33)])
sum_completed_no_geo <- sum(completed)

completed <- complete.cases(df.flat[c(1:46)])
sum_completed_geo <- sum(completed)

```


- `r total` patient encounters were identified.
- `r sum_completed_no_geo` are considered complete cases when geographic variables are not considered.
- Only `r sum_completed_geo` have complete geographic information.
  - This is an estimate. A manual review might recover some cases or exclude others.

<!-- ## Aims -->
<!-- - How much traffic are we seeing in SDC/EC? -->
<!-- - What are the top ICD-10 codes associated with a readmission? -->
<!-- - Who returned? -->
<!-- - What relationship does this have with our predictors? -->
<!-- - Who returned more than once (frequent fliers)? -->
<!-- - How many times are they coming back? -->
<!-- - How often are they coming back? -->
<!-- - Why are they coming back? -->
<!-- - Where/who are they returning too? -->
<!-- - Which sites are they coming from? -->
<!-- - Can we predict return? -->

## Table 1 - All SDC Encounters

```{r table1}

df.comp <- df.flat %>% 
  mutate(
    return_in_14 = as.factor(return_in_14),
    return_in_14_sdc = as.factor(return_in_14_sdc),
    RUCC_2013 = as.factor(RUCC_2013),
    po_box = as.factor(po_box)
  ) %>% 
  select(
    AdmitAge,
    Sex,
    Race,
    Fed_Ethnicity,
    tribal_affil,
    Language,
    Marital_Status,
    Religion_binary,
    median_income_2018,
    median_home_value_2018,
    return_in_14,
    return_in_14_sdc,
    Building,
    days_to_return,
    RUCC_2013,
    po_box,
    dist_eu_pt_sdc,
    dist_eu_pt_return
  )

comp.obj <- compareGroups(
  return_in_14 ~ .,
  df.comp,
  max.xlev = 60
)

createTable(comp.obj, show.p.overall = FALSE, show.all = TRUE) %>% export2md(caption = "Descriptive table for demographic variables for all enounters, separated by whether the encounter was followed by a readmission within fourteen days (TRUE) or not (FALSE).")

comp.obj <- compareGroups(return_in_14_sdc ~. -return_in_14, df.comp)

createTable(comp.obj, show.p.overall = FALSE, show.all = TRUE) %>% export2md(caption = "Descriptive table for demographic variables for all enounters, separated by whether the encounter was followed by an encounter at Same Day Care within 14 days.")
```

```{r plots}

df.flat %>% 
  ggplot(
    aes(DTS, fill=return_types)
  ) +
  geom_histogram(bins = 36, alpha = 0.75) +
  theme_classic() +
  labs(
    title = "Same Day Care Encounters by Time of Year",
    x = "Date",
    y = "Total Visits",
    fill = "Return in 14 days",
    caption = "This plot depicts the number of encounters occuring at Same Day Care and Express Care facilities during the study period, binned by month."
  )

```


```{r visitsPerPt}
# plot: number of visits to SDC/EC
traffic <- df.flat %>% 
  group_by(
    PersonID
  ) %>% 
  summarise(
    n = n()
  ) %>% 
  ungroup()

traffic %>% 
  ggplot(
    aes(n)
  ) +
  geom_histogram(binwidth = 1) +
  scale_y_log10() +
  theme_classic() +
  labs(
    title = "Distribution of Number of Visits to SDC/EC",
    x = "Number of Visits",
    y = "Log10 of Number of Individuals",
    caption = "This depicts the number of individuals making a specified number of visits to SDC/EC during the years 2017-2019."
  )

```

## Frequent Fliers

```{r frqtFlyers}
ff <- df.flat %>%
  group_by(
    PersonID,
    NurseUnit
  ) %>% 
  summarise(
    `TotalVisits` = n()
  ) %>% 
  ungroup() %>% 
  filter(
    NurseUnit %in% SDCEC
  ) %>% 
  group_by(
    PersonID
  ) %>% 
  summarise(
    Total_SDC_Visits = sum(TotalVisits)
  ) %>% 
  ungroup() %>% 
  right_join(
    df.flat,
    by = c("PersonID" = "PersonID")
  ) %>% 
  mutate(
    return_in_14 = as.character(return_in_14)
  ) %>% 
  mutate(
    ff = if_else(
      `Total_SDC_Visits` >= 
        quantile(Total_SDC_Visits, prob = 0.95, na.rm = TRUE),
      "Frequent flier",
      "Infrequent flier"
    )
  )

ff.comp <- compareGroups(ff ~  Total_SDC_Visits+return_in_14_sdc+return_in_14+Sex+AdmitAge+Race+Fed_Ethnicity+tribal_affil+RUCC_2013+median_income_2018+median_home_value_2018+dist_eu_pt_sdc+dist_eu_pt_return,
                         ff,
                         max.xlev = 55)

ff.comp %>% createTable(show.all = TRUE, show.p.overall = FALSE) %>% export2md()

chisq.test(ff$return_in_14,ff$ff)

```

## Demographic factors | What seems to have a sorting effect?

```{r chiOfCategoricals}

cat_vars <- c("Fed_Ethnicity",
              "Language",
              "Race",
              "Marital_Status",
              "Sex",
              "Religion_binary",
              "Building",
              "NurseUnit",
              "ZipCode",
              "ff")

CatChi <- data.frame(
  variable = as.character(),
  Xsq = as.numeric(),
  df = as.numeric(),
  p = as.numeric(),
  row.names = NULL
)

CatChiList <- list()

for (cat in cat_vars){
  res <- chisq.test(
    ff[[cat]],
    ff$return_in_14_sdc
  )
  
  if (res$p.value < 0.05){
    res.df <- data.frame(
      variable = cat,
      Xsq = res$statistic,
      df = res$parameter,
      p = res$p.value,
      row.names = NULL
    )
    
    CatChi <- rbind(CatChi, res.df)
    
    CatChiList[[cat]] <- res
    
    residuals <- data.frame(res$residuals) %>% 
      rename(
        Residual = Freq
      )
    
    Zscores <- data.frame(100*res$residuals^2/res$statistic) %>% 
      rename(
        Z = Freq
      ) %>% 
      mutate(
        Significant = if_else(
          abs(Z) > 1.96,
          TRUE,
          FALSE
        )
      )
    
    residuals <- residuals %>% 
      left_join(Zscores)
    
    CatChiList[[paste(cat,"_plot", sep = "")]] <- residuals %>% 
      ggplot(
        aes(
          ff..cat..,
          ff.return_in_14_sdc,
          size = Z,
          shape = Significant,
          color = Residual
        )
      ) +
      geom_point(alpha = 0.7) +
      theme_classic() +
      scale_color_gradient2(low = "#0000ff", mid = "#008000", high = "#ff0000") +
      labs(
        title = paste(cat, "Significance Plot"),
        y = "Returned in 14 days to SDC",
        x = cat,
        size = "St. Residual",
        shape = "Significance, p < 0.05"
      ) + 
      theme(
        axis.text.x = element_text(angle = 90)
      )

  }

}

print(CatChiList)

```

## Continuous Variables

```{r}
col.df <- data.frame(name = colnames(df.flat))
col.df$class <- apply(col.df, 1, function(x) class(df.flat[[x]]))

col.continuous <- col.df %>% 
  filter(
    class == 'numeric'
  ) %>% 
  mutate(
    class = unlist(class)
  ) %>% 
  filter(
    !(name %in% c("PersonID",
                  "EncounterID",
                  "DiagnosisPrioritySEQ",
                  "id",
                  "days_to_return"))
  )

continuous.list <- list()

for (var in col.continuous$name){
  mods <- glm(df.flat$return_in_14_sdc~df.flat[[var]],
               df.flat,
               family = "binomial")
  
  summ <- summary(mods)
  p<- as.data.frame(summ$coefficients)
  p <- p[2,4]
  
  if (p<=0.05){
    continuous.list[[var]]<-summ
    continuous.list[[paste(var,"_plot",sep = "")]] <- ggplot(df.flat,
                                                             aes(.data[[var]],
                                                                 return_in_14_sdc)) +
      geom_jitter() +
      theme_classic() +
      labs(
        x = var
      ) +
      scale_x_log10()
  }
}

print(continuous.list)

```

<!-- ## Geography | Where are they from? -->

<!-- - what proportion of SDC encounters from each neighborhood results in a return? A return to SDC or to other facility? -->

## ICD-10 Codes

```{r icd10}
## most common Priority ICD10
df.icd.counts <- df.flat %>% 
  group_by(ICD_code, return_in_14) %>% 
  summarise(
    n = n()
  ) %>% 
  ungroup() %>% 
  arrange(
    desc(return_in_14),
    desc(n)
  ) %>% 
  pivot_wider(
    names_from = return_in_14,
    values_from = n,
    values_fill = 0
  ) %>% 
  mutate(
    ratio = `TRUE`/`FALSE`,
    percentage = `TRUE`/(`FALSE` + `TRUE`)
  ) %>% 
  arrange(
    desc(percentage),
    desc(`TRUE`)
  )

## priority ICD-10 with most significant association with readmission
df.chi <- df.flat %>% 
  mutate(
    n = 1
  ) %>% 
  pivot_wider(
    names_from = ICD_code,
    values_from = n,
    values_fill = 0
  )

df.chi.results <- data.frame(ICD = as.character(),
                             Chi2 = as.numeric(),
                             p = as.numeric())

for (i in seq(54, length(colnames(df.chi)))){
  chiTest <- chisq.test(
    df.chi$return_in_14,
    df.chi[[i]]
  )
  
  a <- colnames(df.chi)[i]
  
  res <- data.frame(ICD = a,
                    Chi2 = chiTest$statistic,
                    p = chiTest$p.value)
  
  df.chi.results <- rbind(df.chi.results, res)
}

row.names(df.chi.results) <- NULL

df.icd.sig <- df.icd.counts %>% 
  left_join(
    df.chi.results,
    by = c("ICD_code" = "ICD")
  )


df.icd.counts <- NULL
df.chi.results <- NULL

## top 50 ICD-10 codes
top50 <- df.icd.sig %>% 
  arrange(
    desc(Chi2),
    p
  ) %>% 
  head(50) %>% 
  left_join(
    ICD[c(1,3,6:8)],
    by = c("ICD_code" = "code")
  ) %>% 
  arrange(
    desc(ratio)
  )

knitr::kable(top50) %>% kableExtra::kable_styling(bootstrap_options = c("striped","condensed"))

```

# Next Steps
Topic Modelling reason for visit. Could this alone be used to predict return?
- Develop primary model, probably via XGBoost
- Also consider [association rules](https://towardsdatascience.com/association-rule-mining-in-r-ddf2d044ae50) or [sequence mining](https://www.r-bloggers.com/2020/10/sequence-mining-my-browsing-history-with-arulessequences/?__twitter_impression=true "This is just a link to a walkthrough").


## Potentially enriching data to add.
- Basic vital signs, Rx, preexisting conditions.
- Previous LOS, days since last encounter.

## Ethical Considerations
- What to do when the model stratifies a patient as high risk? What information do we need to guide a course of action?
- What do we do with false positives? Financial repercussions?
- What do we do with false negatives? Liability?

## Potential other studies/comparisons
- Consider comparison against all other primary care visits. E.g. Is there a difference in the number of single individuals accessing care between PCP's and SDC?
- Consider using this as a case study for cleaning up how data is entered.
- Consider doing a PCA to examine latent variables and correlations.
- Maybe targeted interventions for minority populations, e.g. park a mobile clinic on/near a reservation at a regular time each week to facilitate care.
- Examine demographic information on a per capita basis (e.g. returns/neighborhood population).

## Data Issues
- Chronic disease tables are terrible as is. Need to create SAM or something. How to determine? Presence of relevant ICD-10 in the past 5-10 years? Look for prescribed medications?
- Why are some encounterID's '0'?
- Consider regulation of address information and differentiating between mailing and residential address. This important in terms of readiness to track disease outbreaks and public health interventions. E.g. PO Box addresses should be entered as a mailing address not a home address. 'Attn. John Doe' should be entered as the second or third line for street address. Not first.
- What/where is *Same Day Care* Nurse Unit? Why are the number of buildings and Nurse Units different? Shouldn't they be the same? If not, why?
- Is 14 days really the optimal window?

# Future steps
- Deployment in medical reports
- Blinded trials
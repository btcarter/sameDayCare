---
title: "Descriptive Analysis v0.2"
author: "Benjamin T. Carter, PhD"
date: "Generated: `r Sys.time()`"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    fig_width: 6
    fig_height: 12
params:
  respVar: "return_in_14"
  d.frame: "did you forget me?"
---

```{r include=FALSE}
knitr::opts_chunk$set(message=FALSE, error=FALSE, warning=FALSE)
```


```{r environment}
# packages

library(dplyr)
library(tidyr)
library(lubridate)
library(compareGroups)

# data
d.frame <- params$d.frame
respVar <- params$respVar

# variable lists
# identify variable types and make lists
numeric.vars <- unlist(lapply(d.frame, is.numeric))
boolean.vars <- unlist(lapply(d.frame, is.logical))
categorical.vars <- unlist(lapply(d.frame, is.character))
categorical.vars <- union(categorical.vars,
                          unlist(lapply(d.frame, is.factor)))

```

# Overview

## Table 1

```{r table1}

if (is.logical(d.frame[[respVar]])) {
  d.frame[[respVar]] <- as.factor(d.frame[[respVar]])
}

thing <- paste(respVar, "~", " .", sep = "")

comp.obj <- compareGroups(
  thing,
  d.frame,
  max.xlev = 22
)

cap <- paste("Descriptive table for ", respVar, ".", sep = "")

createTable(comp.obj, show.p.overall = FALSE, show.all = TRUE) %>% export2md(caption = cap)

```

# Variables Associated with `r respVar`

## Categorical factors

```{r chiOfCategoricals}

cat_vars <- c("Fed_Ethnicity",
              "Language",
              "Race",
              "Marital_Status",
              "Sex",
              "Religion_binary",
              "Building",
              "NurseUnit",
              "ZipCode",
              "ff")

CatChi <- data.frame(
  variable = as.character(),
  Xsq = as.numeric(),
  df = as.numeric(),
  p = as.numeric(),
  row.names = NULL
)

CatChiList <- list()

for (cat in cat_vars){
  res <- chisq.test(
    d.frame[[cat]],
    d.frame[[respVar]]
  )
  
  if (res$p.value < 0.05){
    res.df <- data.frame(
      variable = cat,
      Xsq = res$statistic,
      df = res$parameter,
      p = res$p.value,
      row.names = NULL
    )
    
    CatChi <- rbind(CatChi, res.df)
    
    CatChiList[[cat]] <- res
    
    residuals <- data.frame(res$residuals) %>% 
      rename(
        Residual = Freq
      )
    
    Zscores <- data.frame(100*res$residuals^2/res$statistic) %>% 
      rename(
        Z = Freq
      ) %>% 
      mutate(
        Significant = if_else(
          abs(Z) > 1.96,
          TRUE,
          FALSE
        )
      )
    
    residuals <- residuals %>% 
      left_join(Zscores)
    
    CatChiList[[paste(cat,"_plot", sep = "")]] <- residuals %>% 
      ggplot(
        aes(
          d.frame..cat..,
          d.frame..respVar..,
          size = Z,
          shape = Significant,
          color = Residual
        )
      ) +
      geom_point(alpha = 0.7) +
      theme_classic() +
      scale_color_gradient2(low = "#0000ff", mid = "#008000", high = "#ff0000") +
      labs(
        title = paste(cat, "Significance Plot"),
        y = respVar,
        x = cat,
        size = "St. Residual",
        shape = "Significance, p < 0.05"
      ) + 
      theme(
        axis.text.x = element_text(angle = 90)
      )

  }

}

print(CatChiList)

```

## Continuous Variables

```{r continuousVars}
col.df <- data.frame(name = colnames(d.frame))
col.df$class <- apply(col.df, 1, function(x) class(d.frame[[x]]))

col.continuous <- col.df %>% 
  filter(
    class == 'numeric'
  ) %>% 
  mutate(
    class = unlist(class)
  ) %>% 
  filter(
    !(name %in% c("PersonID",
                  "EncounterID",
                  "DiagnosisPrioritySEQ",
                  "id",
                  "days_to_return"))
  )

continuous.list <- list()

for (var in col.continuous$name){
  mods <- glm(d.frame[[respVar]]~d.frame[[var]],
               d.frame,
               family = "binomial")
  
  summ <- summary(mods)
  p<- as.data.frame(summ$coefficients)
  p <- p[2,4]
  
  if (p<=0.05){
    continuous.list[[var]]<-summ
    continuous.list[[paste(var,"_plot",sep = "")]] <- ggplot(d.frame,
                                                             aes(.data[[var]],
                                                                 .data[[respVar]])) +
      geom_jitter() +
      theme_classic() +
      labs(
        x = var
      ) +
      scale_x_log10()
  }
}

print(continuous.list)

```

## ICD-10 Codes

```{r icd10codes}
## most common Priority ICD10
df.icd.counts <- d.frame %>% 
  group_by(ICD_code, .data[[respVar]]) %>% 
  summarise(
    n = n()
  ) %>% 
  ungroup() %>% 
  arrange(
    desc(.data[[respVar]]),
    desc(n)
  ) %>% 
  pivot_wider(
    names_from = .data[[respVar]],
    values_from = n,
    values_fill = 0
  ) %>% 
  mutate(
    ratio = `TRUE`/`FALSE`,
    percentage = `TRUE`/(`FALSE` + `TRUE`)
  ) %>% 
  arrange(
    desc(percentage),
    desc(`TRUE`)
  )

## priority ICD-10 with most significant association with readmission
df.chi <- d.frame %>% 
  mutate(
    n = 1
  ) %>% 
  pivot_wider(
    names_from = ICD_code,
    values_from = n,
    values_fill = 0
  )

df.chi.results <- data.frame(ICD = as.character(),
                             Chi2 = as.numeric(),
                             p = as.numeric())

for (i in seq(59, length(colnames(df.chi)))){
  chiTest <- chisq.test(
    df.chi[[respVar]],
    df.chi[[i]]
  )
  
  a <- colnames(df.chi)[i]
  
  res <- data.frame(ICD = a,
                    Chi2 = chiTest$statistic,
                    p = chiTest$p.value)
  
  df.chi.results <- rbind(df.chi.results, res)
}

row.names(df.chi.results) <- NULL

df.icd.sig <- df.icd.counts %>% 
  left_join(
    df.chi.results,
    by = c("ICD_code" = "ICD")
  )


df.icd.counts <- NULL
df.chi.results <- NULL

## top 50 ICD-10 codes
top50 <- df.icd.sig %>% 
  arrange(
    desc(Chi2),
    p
  ) %>% 
  head(50) %>% 
  left_join(
    ICD[c(1,3,6:8)],
    by = c("ICD_code" = "code")
  ) %>% 
  arrange(
    desc(ratio)
  )

knitr::kable(top50) %>% kableExtra::kable_styling(bootstrap_options = c("striped","condensed")) %>% kableExtra::scroll_box(width = "100%", height = "1000px")

```

## ICD-10 Chapters

```{r icd10chapters, fig.height='1000px'}
## most common ICD10 chapter
df.icd.counts <- d.frame %>% 
  group_by(chapter, .data[[respVar]]) %>% 
  summarise(
    n = n()
  ) %>% 
  ungroup()


# chi square
res.df <- d.frame %>% 
  select(
    .data[[respVar]], 
    chapter
  ) %>%
  mutate(
    chapter = as.character(chapter)
  ) %>% 
  mutate(
    chapter = if_else(
      is.na(chapter),
      "No affiliated chapter",
      chapter
    )
  ) %>% 
  mutate(
    chapter = as.factor(chapter),
    # .data[[respVar]] = as.factor(.data[[respVar]])
  )

res <- chisq.test(res.df$chapter, res.df[[respVar]])
res

residuals <- data.frame(res$residuals) %>%
  rename(
    Residual = Freq
  )
    
Zscores <- data.frame(100*res$residuals^2/res$statistic) %>% 
  rename(
    Z = Freq
  ) %>% 
  mutate(
    Significant = if_else(
      abs(Z) > 1.96,
      TRUE,
      FALSE
    )
  )
    
residuals <- residuals %>% 
  left_join(Zscores)

residuals %>% 
  ggplot(
    aes(
      res.df.chapter,
      res.df..respVar..,
      size = Z,
      shape = Significant,
      color = Residual
    )
  ) +
  geom_point(alpha = 0.7) +
  theme_classic() +
  scale_color_gradient2(low = "#0000ff", mid = "#008000", high = "#ff0000") +
  labs(
    title = paste("ICD Chapter Significance"),
    y = respVar,
    x = "Chapter",
    size = "St. Residual",
    shape = "Significance, p < 0.05"
  ) + 
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1)
  )

```

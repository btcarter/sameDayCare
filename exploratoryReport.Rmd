---
title: "SDC Exploration"
author: "Benjamin Carter"
date: "4/9/2020"
output: 
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r setTheMood, message=FALSE, warning=FALSE}
# environment ####
library(readxl)
library(dplyr)
library(table1)
library(ROSE)
library(ggplot2)
library(mltools)

# get data ####
WB <- file.path("C:",
                "Users",
                "CarteB",
                "OneDrive - BILLINGS CLINIC",
                "projects",
                "sdc",
                "data",
                "Same Day Care_Express Care 2014_2015 patients 3_25_2020-2.xlsx")
df <- read_xlsx(WB)
```

```{r preprocessing, message=FALSE, warning=FALSE}
# preprocessing ####
df$Tribe <- na_if(df$Tribe, ".")

df.processed <- df %>%
  select(
    "id" = `Person MPI number`,
    "lungDx" = `Lung disease Diagnosis`,
    "diabetesDx" = `Diabetes Diagnosis`,
    "heartFailureDx" = `Heart Failure Diagnosis`,
    "sex" = Sex,
    "race" = Race,
    "ethnicity" = Ethnicity,
    "tribe" = Tribe,
    "age" = `Age in Years at Visit`,
    "SdcDate" = `SDC_EC Admit Date`,
    ICD9_SDC_EC,
    "Sdc_reason" = `SDC_EC Reason for Visit`,
    "SdcCollapsedReason" = `Collapsed Reason for visit`,
    "categorization" = `Categorization: Hospitalization, No hospitalization, Referred by SDC, Not noticed at SDC`,
    "SdcLocation" = `SDC_EC Location`,
    "Sdc_or_Ec" = `SDC or EC visit?`,
    "return_in_14" = `did pt have hospital visit within 14 days`,
    "PCP" = `Did patient have a PCP?`,
    "Encounter_type" = `Encounter Type`
  ) %>%
  mutate(
    lungDx = as.logical(lungDx),
    diabetesDx = as.logical(diabetesDx),
    heartFailureDx = as.logical(heartFailureDx),
    sex = as.factor(sex),
    race = as.factor(race),
    ethnicity = as.factor(ethnicity),
    tribe = as.factor(tribe),
    SdcCollapsedReason = as.character(SdcCollapsedReason),
    categorization = as.factor(categorization),
    SdcLocation = as.factor(SdcLocation),
    Sdc_or_Ec = as.factor(Sdc_or_Ec),
    Encounter_type = as.factor(Encounter_type),
    PCP = ifelse(PCP == "Yes", TRUE, FALSE)
  )
```

# Data processing

The following variables were included from the original data set for this analysis: Lung disease diagnosis, diabetes diagnosis, heart failure diagnosis, sex, race, ethnicity, tribe, age, same-day care admit date, ICD 9 code, SDC reason for visit, collapsed reason for visit, categorization, SDC location, SDC or EC visit, whether the patient returned in the following 14 days, whether the patient had a PCP, and encounter type.

# Exploring the data

## Demographics

Before I started trying to recreate the analysis, I decided to take a summary look at the data. I renamed some of the variables to make it easier to code the analysis later (save me having to insert a lot of quotation marks and apostrophes) so the names are similar, but not identical.

I got things started by creating a Table 1 (see below). A few things stick out to me, first there are some errors in the data. For example, one of the entries under `SdcLocation` was 2014. Looking at the data, I tihnk this entry got shifted to the right somehow, but I am not certain. This is also why we have one entry in the `Sdc_or_Ec` (SDC or EC visit) as SDC Down, and a `categorization` of 0 for one participant. Other errors may be present but they don't show up in Table 1. This isn't a huge issue for the model as it is just one data point, but is worth noting.

Some of these variables appear to be less useful than I had hoped, i.e. `categorization` so I'm just going to eliminate them from this point in the analysis. I don't think categorization is useful because (from what I can tell) it denotes whether someone went to the ER straight from Same Day Care.

The next thing that stuck out was the lack of balance, something David had to compensate for in his analysis. The primary

```{r table1, message=FALSE, warning=FALSE}
table1( ~ lungDx +
  diabetesDx +
  heartFailureDx +
  sex +
  race +
  ethnicity +
  age +
  SdcCollapsedReason +
  categorization +
  SdcLocation +
  Sdc_or_Ec +
  PCP +
  Encounter_type | return_in_14,
  data = df.processed
)
```


## Test model

Just as a check I ran a quick logistic model on the whole data set. Here's what I found for significance.

```{r startModel, warning=FALSE, echo=FALSE}
# Is something there?
model.logistic <- glm(
  return_in_14 ~ lungDx + diabetesDx + heartFailureDx + sex + race + ethnicity + age + SdcDate + SdcCollapsedReason,
  data = df.processed,
  family = "binomial"
) %>% summary()

knitr::kable(model.logistic$coefficients)
```

Unfortunately `r length(model.logistic$na.action)` observations were eliminated due to in adequate data (too many NA's, most of which had an unknown Collapsed Reason for Visit) so this model excluded `r length(model.logistic$na.action)/nrow(df)` of the total observations.

## Additional modifications to the data

Based on these results I modified the data to handle `NA`'s as strings instead.

```{r preprocessing2, message=FALSE,warning=FALSE}
df.processed2 <- df.processed %>%
  mutate(
    SdcCollapsedReason = ifelse(is.na(SdcCollapsedReason), "NA", SdcCollapsedReason),
    tribe = ifelse(is.na(tribe), "NA", tribe),
    Sdc_reason = ifelse(is.na(Sdc_reason), "NA", Sdc_reason),
    ICD9_SDC_EC = ifelse(is.na(ICD9_SDC_EC), "NA", ICD9_SDC_EC)
  )
  

# check for missing values
# which(!complete.cases(df.processed2))
```

```{r testModel2, warning=FALSE,message=FALSE}
model.logistic <- glm(
  return_in_14 ~ lungDx + diabetesDx + heartFailureDx + sex + race + ethnicity + age + SdcDate + SdcCollapsedReason,
  data = df.processed2,
  family = "binomial"
) %>% summary()

knitr::kable(model.logistic$coefficients)
```

# Recreating Hedges

## Methods

### Attempt 1

As part of this first attempt, the model was limited to only a subset of possible variables.

```{r ml_preprocessing, message=FALSE, warning=FALSE, include=FALSE}
# Reproducing Hedges ####
df.processed.ml <- df.processed2 %>%
  select(
    "id", "lungDx", "diabetesDx", "heartFailureDx", "sex", "race", "ethnicity", "tribe", "age",
    "SdcCollapsedReason", "return_in_14", "PCP", "Encounter_type"
  )

# one hot encoding
for (VAR in c("race", "ethnicity", "tribe", "SdcCollapsedReason", "Encounter_type")){
  for(unique_value in unique(df.processed.ml[[VAR]])){
    df.processed.ml[paste(VAR, unique_value, sep = ".")] <- ifelse(df.processed.ml[[VAR]] == unique_value, 1, 0)
    df.processed.ml[[VAR]] <- NULL
    }
  }

# Balancing the data via random over and undersampling
groups <- table(df.processed.ml$return_in_14)

n_return <- groups[2]

frac <- 0.9

new_total <- n_return/frac

df.train <- ovun.sample(return_in_14 ~ .,
                               data = df.processed.ml,
                               method = "both",
                               N = new_total,
                               seed = 2020
                               )

df.test <- df.processed.ml %>%
  anti_join(
    df.train$data,
    by = "id"
  )

```

I randomly selected `r nrow(df.train$data)` observations to train my models. This included `r df.train$data %>% filter(return_in_14 == "Yes") %>% nrow()` returning cases. This produced the following.


```{r model1, message=FALSE, warning=FALSE}
# logistic model
model.logistic <- glm(
  return_in_14 ~ .,
  data = df.train$data,
  family = "binomial"
)

model.logistic.summary <- model.logistic %>% summary()

knitr::kable(model.logistic.summary$coefficients)

df.test$prediction <- predict(model.logistic, newdata = df.test)

```


```{r chisquare}
test <- chisq.test(df.processed$return_in_14,df.processed$lungDx)
```